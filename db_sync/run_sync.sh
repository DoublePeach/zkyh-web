#!/bin/bash

echo "==============================================="
echo "цХ░цНох║УхРМцнех╖ехЕ╖ - х╝АхзЛхРМцнеш┐ЗчиЛ"
echo "==============================================="
echo "1. х░Жх╝АхПСчОпхвГшбич╗УцЮДхРМцнехИ░чФЯф║зчОпхвГ"
echo "2. х░ЖчФЯф║зчОпхвГчЙ╣хоЪшбицХ░цНохРМцнехИ░х╝АхПСчОпхвГ"
echo "==============================================="

# цгАцЯецХ░цНох║Уш┐ЮцОе
check_connection() {
  local host=$1
  local port=$2
  local user=$3
  local password=$4
  local db=$5
  local env=$6

  echo "цгАцЯе $env цХ░цНох║Уш┐ЮцОе..."
  PGPASSWORD=$password psql -h $host -p $port -U $user -d $db -c "SELECT 1" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "тЬЕ $env цХ░цНох║Уш┐ЮцОецИРхКЯ!"
  else
    echo "тЭМ $env цХ░цНох║Уш┐ЮцОехд▒ш┤е!"
    exit 1
  fi
}

# хКаш╜╜цХ░цНох║УщЕНч╜о
source ./db_sync/db_config.sh

# цгАцЯецХ░цНох║Уш┐ЮцОе
check_connection $DEV_DB_HOST $DEV_DB_PORT $DEV_DB_USER "$DEV_DB_PASSWORD" $DEV_DB_NAME "х╝АхПСчОпхвГ"
check_connection $PROD_DB_HOST $PROD_DB_PORT $PROD_DB_USER "$PROD_DB_PASSWORD" $PROD_DB_NAME "чФЯф║зчОпхвГ"

echo "==============================================="
echo "цнещкд 1: х░Жх╝АхПСчОпхвГшбич╗УцЮДхп╝хЗ║"
echo "==============================================="
./db_sync/export_dev_schema.sh

echo "==============================================="
echo "цнещкд 2: х░Жшбич╗УцЮДхп╝хЕечФЯф║зчОпхвГ"
echo "==============================================="
./db_sync/import_schema_to_prod.sh

echo "==============================================="
echo "цнещкд 3: ф╗ОчФЯф║зчОпхвГхп╝хЗ║чЙ╣хоЪшбицХ░цНо"
echo "==============================================="
./db_sync/export_prod_data.sh

echo "==============================================="
echo "цнещкд 4: х░ЖчЙ╣хоЪшбицХ░цНохп╝хЕех╝АхПСчОпхвГ"
echo "==============================================="
./db_sync/import_data_to_dev.sh

echo "==============================================="
echo "хРМцнехоМцИР! ЁЯСН"
echo "х╖▓хоМцИРф╗еф╕ЛцУНф╜Ь:"
echo "1. х╝АхПСчОпхвГшбич╗УцЮДх╖▓хРМцнехИ░чФЯф║зчОпхвГ"
echo "2. чФЯф║зчОпхвГчЪД chapters хТМ knowledge_points шбицХ░цНох╖▓хРМцнехИ░х╝АхПСчОпхвГ"
echo "===============================================" 